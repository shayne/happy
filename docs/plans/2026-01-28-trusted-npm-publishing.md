# Trusted npm Publishing for Happy Codex CLI Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Publish `happy-codex` to npm via GitHub Actions trusted publishing (OIDC), with dev publishes on `main` and prod publishes on `v*` tags.

**Architecture:** Add a single `.github/workflows/release.yml` that computes versions in a `meta` job, runs a CLI-only build/test job, and publishes via two gated jobs: `publish-npm-dev` (main → dev tag with autogenerated version) and `publish-npm-prod` (v* tags → latest). Both publish jobs use OIDC (`id-token: write`) and `environment: npm` for release approvals. CLI install/build uses Yarn Classic in `cli/` only.

**Tech Stack:** GitHub Actions, npm Trusted Publishing (OIDC), Node.js 24 LTS, Yarn Classic 1.22.x, bash.

---

### Task 1: Create release workflow skeleton + meta job

**Files:**
- Create: `.github/workflows/release.yml`

**Step 1: Write the failing test**

Run: `rg -n "id-token: write" .github/workflows/release.yml`

Expected: FAIL (file not found).

**Step 2: Write minimal implementation**

Create `.github/workflows/release.yml` with:
- `on.push.branches: [main]` and `on.push.tags: ["v*"]`
- `permissions: contents: read`
- `meta` job that outputs: `is_tag`, `is_main`, `version`, `npm_tag`
  - For tag: `version=${GITHUB_REF_NAME#v}`, `npm_tag=latest`
  - For main: `version=0.0.0-dev.<YYYYMMDDHHMMSS>+<short_sha>`, `npm_tag=dev`

**Step 3: Run test to verify it passes**

Run: `rg -n "id-token: write" .github/workflows/release.yml`

Expected: still FAIL (we haven’t added publish jobs yet). This confirms the test is correctly scoped.

**Step 4: Commit**

```bash
git add .github/workflows/release.yml
git commit -m "release: add workflow skeleton and meta job"
```

---

### Task 2: Add CLI-only build/test job

**Files:**
- Modify: `.github/workflows/release.yml`

**Step 1: Write the failing test**

Run: `rg -n "build-cli" .github/workflows/release.yml`

Expected: FAIL (job missing).

**Step 2: Write minimal implementation**

Add `build-cli` job:
- `runs-on: ubuntu-latest`
- `needs: [meta]`
- Steps:
  - Checkout
  - Setup Node 24 (use `actions/setup-node@v4`)
  - `corepack enable`
  - `corepack prepare yarn@1.22.22 --activate`
  - `yarn install --frozen-lockfile` (working-directory: `cli`)
  - `yarn build` (working-directory: `cli`)
  - `yarn test` (working-directory: `cli`)

**Step 3: Run test to verify it passes**

Run: `rg -n "build-cli" .github/workflows/release.yml`

Expected: PASS (job found).

**Step 4: Commit**

```bash
git add .github/workflows/release.yml
git commit -m "release: add cli build/test job"
```

---

### Task 3: Add npm publish jobs (dev + prod) with OIDC + environment

**Files:**
- Modify: `.github/workflows/release.yml`

**Step 1: Write the failing test**

Run: `rg -n "publish-npm-(dev|prod)" .github/workflows/release.yml`

Expected: FAIL (jobs missing).

**Step 2: Write minimal implementation**

Add two jobs:

**`publish-npm-prod`** (prod releases)
- `needs: [meta, build-cli]`
- `if: needs.meta.outputs.is_tag == 'true'`
- `permissions: contents: read, id-token: write`
- `environment: npm`
- Steps:
  - Checkout
  - Setup Node 24 + registry URL
  - Verify tag matches CLI version:
    - `tag=${GITHUB_REF_NAME#v}`
    - `pkg=$(node -p "require('./cli/package.json').version")`
    - Fail if `tag != pkg`
  - `corepack enable`
  - `corepack prepare yarn@1.22.22 --activate`
  - `yarn install --frozen-lockfile` (working-directory: `cli`)
  - `yarn build` (working-directory: `cli`)
  - `npm publish --access public` (working-directory: `cli`)

**`publish-npm-dev`** (dev releases)
- `needs: [meta, build-cli]`
- `if: needs.meta.outputs.is_main == 'true'`
- `permissions: contents: read, id-token: write`
- `environment: npm`
- Steps:
  - Checkout
  - Setup Node 24 + registry URL
  - `corepack enable`
  - `corepack prepare yarn@1.22.22 --activate`
  - `yarn install --frozen-lockfile` (working-directory: `cli`)
  - `npm version --no-git-tag-version ${{ needs.meta.outputs.version }}` (working-directory: `cli`)
  - `yarn build` (working-directory: `cli`)
  - `npm publish --access public --tag dev` (working-directory: `cli`)

**Step 3: Run test to verify it passes**

Run: `rg -n "id-token: write|environment: npm|publish-npm-(dev|prod)" .github/workflows/release.yml`

Expected: PASS (jobs and permissions present).

**Step 4: Commit**

```bash
git add .github/workflows/release.yml
git commit -m "release: add npm trusted publishing jobs"
```

---

### Task 4: Update CLI publishing docs

**Files:**
- Modify: `cli/CONTRIBUTING.md`

**Step 1: Write the failing test**

Run: `rg -n "Trusted Publishing|OIDC|v[0-9]" cli/CONTRIBUTING.md`

Expected: FAIL (no mention of CI publish flow).

**Step 2: Write minimal implementation**

Update “Publishing to npm” section to state:
- Prod publishes happen via GitHub Actions on `v*` tags.
- Dev publishes happen on `main` with tag `dev` and autogenerated version.
- Trusted publishing uses the GitHub Actions workflow `release.yml` and environment `npm`.

**Step 3: Run test to verify it passes**

Run: `rg -n "Trusted Publishing|OIDC|v[0-9]" cli/CONTRIBUTING.md`

Expected: PASS (new text found).

**Step 4: Commit**

```bash
git add cli/CONTRIBUTING.md
git commit -m "docs: document npm trusted publishing"
```

---

### Task 5: Sanity check workflow locally

**Files:**
- None

**Step 1: Run checks**

Run: `rg -n "on:|meta:|publish-npm" .github/workflows/release.yml`

Expected: Shows trigger, meta job, and publish jobs.

**Step 2: Report status**

If any expected section is missing, fix in a follow-up commit.
